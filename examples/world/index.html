<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>Walking Live</title>
<script type="text/javascript" src="jsio/jsio.js"></script>
<script>
jsio.require('jsio', 'Class');
jsio.require('jsio.util.browser', '$');
jsio.require('world.client', 'WorldClient');
jsio.require('jsio.logging');
jsio.logging.getLogger('world.client').setLevel(0);

/* Config
 *********/

var gWidth = 640;
var gHeight = 480;
var gPlayers = [];
var gMaxDelta = 3;
var gPlayerDim = 25;

var gKeys = {};
var gSprite = {
	up: [165, -5],
	down: [223, -5],
	left: [104, -5],
	right: [283, -38]
};

var gBoardEl = null;

/* Main loop
 ************/

window.onload = function() {
	gBoardEl = $.id('board');
	$.style(gBoardEl, {width: gWidth + 'px', height: gHeight + 'px'});
	
	var url;
	
	var joinInput = $.id('join');
	var sayInput = $.id('say');
	var wrapper = $.id('wrapper');	
	var joinBtn = $.id('joinBtn');
	var sayBtn = $.id('sayBtn');
	
	$.hide(sayBtn); $.hide(sayInput);
	$.onEvent(joinInput, 'keyup', function(e) { if(e.keyCode == 13) { join(); }});
	$.onEvent(joinBtn, 'click', join);
	
	function join() {
		if(!joinInput.value.length) { return; }

		client = new WorldClient(joinInput.value, url || 'http://www.google.com/favicon.ico');
	    jsio.connect(client, 'csp', {url:"http://" + document.domain + ":5555"});

		sayBtn.style.display = 'inline';
		sayInput.style.display = 'inline';
		$.hide(joinBtn);
		$.hide(joinInput);

		sayInput.value = '';
		sayInput.focus();
		var say = function() {
			client.say(sayInput.value);
			sayInput.value = '';
			sayInput.focus();
		}
		$.onEvent(sayInput, 'keyup', function(e) { if(e.keyCode == 13) { say(); }});
		$.onEvent(sayBtn, 'click', say);

		$.onEvent(document.body, 'mousedown', $.stopEvent);
		$.onEvent(gBoardEl, 'mousedown', function(e) {
			$.stopEvent(e);
			sayInput.focus();
			client.move(e.clientX - wrapper.offsetLeft - 22, e.clientY - wrapper.offsetTop + window.pageYOffset - 22);
		});
	}
}
</script>


<style type="text/css" media="screen">
body, html { margin: 0px; padding: 0px; background: color: #FFF;
background: #222; }

#wrapper {
	margin: 50px auto 0px auto;
	-moz-border-radius: 6px;
	-webkit-border-radius: 6px;
	width: 640px;
	height: 510px;
	position: relative;
	background: #888;
	padding: 10px;
}

#board {
	position: absolute;
	top: 10px;
	left: 10px;
	background: #CCC;
	-moz-border-radius: 6px;
	-webkit-border-radius: 6px;
}

#board .name {
	position: absolute;
	font: 8px Tahoma;
	z-index: 2;
	width: 25px;
	text-align: center;
}

#board .msg {
	position: absolute;
	font: 8px Tahoma;
	z-index: 1;
	opacity: 0.5;
	background: #000;
	-moz-border-radius: 3px;
	-webkit-border-radius: 3px;
	padding: 3px;
	color: #FFF;
	max-width: 135px;
}

#board .player {
	position: absolute;
	background: url('player-sprite.png');
}

#console {
	position: absolute;
	bottom: 0px;
	width: 640px;
	text-align: center;
}
#say, #join {
	width: 200px;
	margin: 10px auto;
}
</style>
	</head>
	<body>
		<div id="wrapper">
			<div id="board"></div>
			<div id="console">
				<input type="text" id="join">
				<button id="joinBtn">join</button>
				<input type="text" id="say">
				<button id="sayBtn">say</button>
			</div>
		</div>
	</body>
</html>
